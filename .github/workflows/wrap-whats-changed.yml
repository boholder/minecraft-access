name: Wrap What's Changed Section of GitHub Releases

on:
  workflow_dispatch:
    inputs:
      release-tag:
        required: true
        description: Release Tag
        type: string

  workflow_call:
    inputs:
      release-tag:
        required: true
        type: string

env:
  TEMP_BODY_FILE: .release_body

jobs:
  wrap:
    name: Wrap
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3

      - name: Get Release Body
        id: get-body
        run: |
          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${context.repo.owner}/${context.repo.repo}/releases/${{ inputs.release-tag }} \
          > .temp_response
          echo "response=$(cat .temp_response)" >> $GITHUB_OUTPUT

      - name: Check If Release Has Been Changed
        id: check
        run: |
          echo ${{ steps.get-body.outputs.response.body }} > ${{ env.TEMP_BODY_FILE }}
          if grep "Auto Generated Release Notes" ${{ env.TEMP_BODY_FILE }} ; then echo "result=true" >> $GITHUB_OUTPUT ; fi

      # Wrap "What's Changed" section with:
      # <details>
      # <summary>Auto Generated Release Notes</summary>
      # <p>
      # ...
      # </p>
      # </details>
      - name: Wrap What's Changed Section
        if: steps.check.outputs.result
        run:
          sed -i "s/^## What's Changed/\<details>\<summary>Auto Generated Release Notes\<\/summary>\<p>\\n## What's Changed\\n/" ${{ env.TEMP_BODY_FILE }}
          printf "\n</p></details>" >> ${{ env.TEMP_BODY_FILE }}

      - name: Apply Changed Release Body to Release
        if: steps.check.outputs.result
        # ref: https://github.com/irongut/EditRelease
        uses: irongut/EditRelease@v1.2.0
        with:
          id: ${{ inputs.release-id }}
          token: ${{ secrets.GITHUB_TOKEN }}
          replacebody: true
          files: ${{ env.TEMP_BODY_FILE }}