name: Wrap What's Changed Section of GitHub Releases

on:
  workflow_call:
    inputs:
      release-id:
        required: true
        type: string

env:
  TEMP_BODY_FILE: .release_body

jobs:
  wrap:
    runs-on: ubuntu-latest
    name: Wrap
    steps:
      - uses: actions/checkout@v3

      - name: Check If Release Has Been Changed
        id: check
        run: if grep "Auto Generated Release Notes" ${{ github.event.release.body }} ; then echo "result=true" >> $GITHUB_OUTPUT ; fi

      # Wrap "What's Changed" section with:
      # <details>
      # <summary>Auto Generated Release Notes</summary>
      # <p>
      # ...
      # </p>
      # </details>
      - name: Wrap What's Changed Section
        if: steps.check.outputs.result
        run:
          echo ${{ github.event.release.body }} > ${{ env.TEMP_BODY_FILE }}
          sed -i "s/^## What's Changed/\<details>\<summary>Auto Generated Release Notes\<\/summary>\<p>\\n## What's Changed\\n/" ${{ env.TEMP_BODY_FILE }}
          printf "\n</p></details>" >> ${{ env.TEMP_BODY_FILE }}

      - name: Apply Changed Release Body to Release
        if: steps.check.outputs.result
        # ref: https://github.com/irongut/EditRelease
        uses: irongut/EditRelease@v1.2.0
        with:
          id: ${{ inputs.release-id }}
          token: ${{ secrets.GITHUB_TOKEN }}
          replacebody: true
          files: ${{ env.TEMP_BODY_FILE }}